<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Big Problems - Bingo</title>
    <style>
        #stats-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            /* --- ZONE DE SCROLL --- */
            max-height: 350px; 
            overflow-y: auto;  
            padding: 10px 0;
            margin-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: rgba(0,0,0,0.01);
        }

        /* Personnalisation de la barre de scroll */
        #stats-content::-webkit-scrollbar { width: 6px; }
        #stats-content::-webkit-scrollbar-track { background: transparent; }
        #stats-content::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
        
        /* --- Styles de base identiques --- */
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; background-color: #f0f2f5; padding: 10px; overflow-x: hidden;
        }

        h1 { color: #333; margin-bottom: 15px; text-shadow: 1px 1px 0px white; font-size: 1.5rem; }

        /* --- Boutons Navigation --- */
        #presence-toggle-btn, #hof-btn { 
            position: absolute; top: 15px; background: white; border: none; 
            border-radius: 50%; width: 45px; height: 45px; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; 
        }
        #presence-toggle-btn { left: 15px; font-size: 1.2rem; }
        #hof-btn { right: 15px; font-size: 1.5rem; }

        /* --- Panneau Pr√©sence --- */
        #presence-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; z-index: 3500; }
        #presence-overlay.visible { display: block; }

        #presence-settings {
            background: #fff; border-radius: 12px; padding: 20px;
            width: 90%; max-width: 450px; box-sizing: border-box;
            position: fixed; top: -100%; left: 50%; transform: translateX(-50%);
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 4000; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        #presence-settings.visible { top: 20px; }

        .check-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
        .check-item {
            display: flex; align-items: center; font-size: 0.8rem; cursor: pointer;
            background: #f9f9f9; padding: 8px; border-radius: 5px; border: 1px solid #eee;
        }
        
        /* Nouveau Bouton G√©n√©rer */
        #generate-btn {
            background: #4CAF50; color: white; border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;
            font-size: 1rem; margin-top: 10px; transition: background 0.2s;
        }
        #generate-btn:hover { background: #45a049; }

        /* --- Bingo Card & Cells --- */
        #bingo-card {
            display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr);
            grid-gap: 3px; width: 100%; max-width: 450px; aspect-ratio: 1 / 1;
            background-color: #ccc; padding: 5px; border-radius: 10px;
        }
        .bingo-cell {
            background-color: #fff; border-radius: 4px; display: flex;
            align-items: center; justify-content: center; text-align: center;
            padding: 4px; cursor: pointer; font-size: clamp(9px, 2.8vw, 12px);
            font-weight: 600; color: #444; position: relative; overflow: hidden;
        }
        .bingo-cell.clicked::after {
            content: ""; position: absolute; inset: 0;
            background-image: url(data:image/png;base64, lien);
            background-size: 80%; background-repeat: no-repeat; background-position: center;
            opacity: 0.8; pointer-events: none; animation: stamp 0.2s ease-out;
        }

        #reset-btn { margin-top: 20px; padding: 12px 25px; border: none; background: #333; color: white; border-radius: 50px; cursor: pointer; font-weight: bold; }
        #hof-panel { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; padding-top: 50px; opacity: 0; pointer-events: none; transform: scale(1.1); transition: 0.3s; }
        #hof-panel.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        /* --- Podium & Stats (Correction Largeur) --- */
        .hof-item { 
            background: #f8f9fa; 
            padding: 12px 15px; 
            margin: 8px 0; 
            width: 92%; /* Largeur augment√©e */
            max-width: 500px; 
            border-radius: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .hof-name {
            font-weight: 700;
            font-size: 1rem;
            color: #222;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1; /* Tr√®s important : prend toute la place √† gauche */
            text-align: left;
        }

        .hof-score {
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #495057;
            font-weight: bold;
            white-space: nowrap; /* Emp√™che le retour √† la ligne du score */
            margin-left: 10px;
        }
        #bingo-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; background: linear-gradient(45deg, #ff00cc, #3333ff); color: white; font-size: 3rem; font-weight: 900; padding: 20px; border-radius: 20px; z-index: 6000; pointer-events: none; }
        #bingo-message.show { animation: funkyPopup 3s forwards; }
        @keyframes funkyPopup { 0%{opacity:0;transform:translate(-50%,-50%) scale(0)} 15%{opacity:1;transform:translate(-50%,-50%) scale(1.1)} 85%{opacity:1;transform:translate(-50%,-50%) scale(1)} 100%{opacity:0;transform:translate(-50%,-50%) scale(1.5)} }
        .confetti {
            position: fixed; /* Important : fixed et non absolute */
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 7000;
        }
        #admin-reset-hof { position: absolute; top: 15px; right: 15px; background: #ffebee; color: #d32f2f; border: none; padding: 5px 10px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="presence-overlay" onclick="togglePresencePanel()"></div>

    <div id="presence-settings">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <strong style="font-size: 1rem;">üë• Configuration de la partie</strong>
            <button onclick="togglePresencePanel()" style="border:none; background:none; cursor:pointer; font-size: 1.5rem;">√ó</button>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin: 10px 0;">Qui participe aujourd'hui ?</p>
        <div id="check-list" class="check-grid"></div>
        
        <button id="generate-btn" onclick="confirmAndGenerate()">G√âN√âRER LA GRILLE</button>
    </div>

    <div id="hof-panel">
        <button id="admin-reset-hof" onclick="resetHof()">R√©initialiser la saison</button>
        <h2>üèÜ Podium des Champions üèÜ</h2>
        <div id="hof-content"></div>
    
        <hr style="width:80%; margin:20px 0; opacity:0.2;">
        <h3>üî• Top Cases üî•</h3>
        <div id="stats-content"></div>
    
        <button onclick="closeHOF()" style="margin-top:20px; padding: 10px 20px;">Fermer</button>
    </div>
    
    <button id="presence-toggle-btn" onclick="togglePresencePanel()">üë•</button>
    <button id="hof-btn" onclick="openHOF()">üèÜ</button>

    <h1>‚ö†Ô∏è Big Problems ‚ö†Ô∏è</h1>
    
    <div id="bingo-message">BINGO!</div>
    <div id="bingo-card"></div>
    <button id="reset-btn">Nouvelle Grille</button>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        function formatName(str) {
            if (!str) return "";
            return str.toLowerCase().replace(/(^|[\s-])\S/g, match => match.toUpperCase());
        }

        function safeEncode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }

        function safeDecode(str) {
            try {
                return decodeURIComponent(Array.prototype.map.call(atob(str), (c) => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch(e) { return atob(str); } // Repli si l'ancien format est encore l√†
        }
        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "big-problems.firebaseapp.com",
            databaseURL: "https://big-problems-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "big-problems", storageBucket: "big-problems.firebasestorage.app",
            messagingSenderId: "", 
            appId: ""
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const STORAGE_KEY = 'bingo_save_v1';
        const staff = ["Aymeric", "Pauline", "Jeremy", "Aurelie", "Alex"];
        const banqueDeMots = [
            { p: "Zoophilie üòª", owner: "Aymeric" }, { p: "Rachel üëΩ", owner: "Aymeric" }, { p: "H word", owner: "Aymeric" },
            { p: "Ga√´tan vient porter les clefs", owner: "Aymeric" }, { p: "Aymeric nous abandonne pour insta", owner: "Aymeric" },
            { p: "Ga√´tan a une nouvelle aventure dans le train", owner: "Aymeric" }, { p: "Bizutage", owner: "Aymeric" }, { p: "Grosso phobie", owner: "Aymeric" },
            { p: "Pauline fait le jeu ¬´ di ¬ª", owner: "Pauline" }, { p: "Les anecdotes de Paupau", owner: "Pauline" }, { p: "Kaamelott üëë", owner: null },
            { p: "Pauline est vieille üëµ", owner: "Pauline" }, { p: "Quelqu'un force le bingo", owner: null }, { p: "üè∞ Ch√¢teau-Double üè∞", owner: "Pauline" },
            { p: "Jeremy mange de la pizza üçï", owner: "Jeremy" }, { p: "Jeremy oublie un truc", owner: "Jeremy" }, { p: "J√©r√©my rajoute du parmesan üßÄ", owner: "Jeremy" },
            { p: "Aur√©lie est pas optimiste", owner: "Aurelie" }, { p: "Aur√©lie s'est lev√© t√¥t üåÖ", owner: "Aurelie" }, { p: "Aur√©lie l'ogre üëπ", owner: "Aurelie" },
            { p: "Probl√®me de famille d'Alex", owner: "Alex" }, { p: "Pedro Pascal", owner: null },
            { p: "Godwin", owner: null }, { p: "Les fachos", owner: null }, { p: "Wrong timing", owner: null }, { p: "Marc", owner: null },
            { p: "Seigneurs des anneaux üßù", owner: null }, { p: "Sondages / Test", owner: null }, { p: "Titre üîû", owner: null },
            { p: "Marie et/ou Ma√©la sont outr√©es", owner: null }, { p: "Chorale", owner: null }, { p: "Pipouille", owner: null },
            { p: "USA üá∫üá≤", owner: null }, { p: "Vol de places", owner: null }, { p: "Romain parle d'IA ü§ñ", owner: null },
            { p: "Manu ce gros con üï∂Ô∏è", owner: null }, { p: "Boulette alimentaire üçù", owner: null }, { p: "Balle perdue üî´", owner: null },
            { p: "Probl√®me de train üöÜ", owner: null }, { p: "C'est scato üí©", owner: null }, { p: "Marseillais ü§¨üèçÔ∏è", owner: null },
            { p: "Antoine est l√† !", owner: null }, { p: "Point cuisine üßë‚Äçüç≥", owner: null }, { p: "Expression invent√©e", owner: null },
            { p: "Marie met plusieurs couches de sel üßÇ", owner: null }, { p: "Premier degr√© üå°Ô∏è", owner: null }, { p: "Ma√©la juge üë©üèª‚Äç‚öñÔ∏è", owner: null }, { p: "Quelqu'un a du charbon sur le visage ü™µüî•", owner: null },
            { p: "üêà Chats / B√©b√© üë∂", owner: null }, { p: "Quelqu‚Äôun r√©p√®te un truc", owner: null }, { p: "On voit une bestiole üêÄ", owner: null },
            { p: "Calvitie √©voqu√©e üë¥", owner: null }, { p: "Anciens cassos du labo", owner: null }, { p: "Quelqu'un loupe son panier üèÄ", owner: null },
            { p: "T le maudit üü†", owner: null }, { p: "Les Zommes ‚ôÇÔ∏è", owner: null }, { p: "Caillou üóø", owner: null }
        ];

        // 2. NAVIGATION
        function togglePresencePanel() {
            const panel = document.getElementById('presence-settings');
            const overlay = document.getElementById('presence-overlay');
            const isVisible = panel.classList.toggle('visible');
            overlay.classList.toggle('visible');
            document.body.style.overflow = isVisible ? 'hidden' : 'auto';
        }

        function openHOF() { document.getElementById('hof-panel').classList.add('active'); }
        function closeHOF() { document.getElementById('hof-panel').classList.remove('active'); }

        // 3. LOGIQUE JEU
        function renderPresenceList() {
            document.getElementById('check-list').innerHTML = staff.map(name => `
                <label class="check-item"><input type="checkbox" class="presence-check" value="${name}" checked> ${name}</label>
            `).join('');
        }

        function confirmAndGenerate() {
            if (confirm("G√©n√©rer une nouvelle grille ? La progression actuelle sera effac√©e.")) {
                localStorage.removeItem(STORAGE_KEY);
                createBingoCard();
                togglePresencePanel(); // Ferme le panneau apr√®s cr√©ation
            }
        }

        function createBingoCard() {
            const card = document.getElementById('bingo-card');
            card.innerHTML = '';
            
        // 1. Liste des bonus disponibles
            let bonusPool = [
                "Si tu lis √ßa, tu me dois une bi√®re üçª", "De la part de la maison", 
                "üéÅ", "P'tit bonus",
                "C'est bien parce que c'est toi", "Julian c'est grave un boss, nan ?",
                "On remercie les absents", "Parce que tu es l√†"
            ];
        
            // M√©lange initial du pool de bonus pour le tirage sans remise
            bonusPool.sort(() => Math.random() - 0.5);
        
            // 2. Filtrage des mots selon les pr√©sents
            const presents = Array.from(document.querySelectorAll('.presence-check:checked')).map(cb => cb.value);
            let filtr√©s = banqueDeMots.filter(m => !m.owner || presents.includes(m.owner));
            
            // On marque les vraies cases
            filtr√©s = filtr√©s.map(item => ({ ...item, isGift: false }));
        
            // 3. Compl√©ter si < 25 (Tirage sans remise)
            if (filtr√©s.length < 25) {
                const manquant = 25 - filtr√©s.length;
                for (let i = 0; i < manquant; i++) {
                    // On prend le i-√®me √©l√©ment du pool m√©lang√©
                    const text = bonusPool[i] || "Case libre ‚ú®"; 
                    filtr√©s.push({ p: text, owner: null, isGift: true });
                }
            }
            
            // 4. M√©lange final Fisher-Yates pour la grille
            for (let i = filtr√©s.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filtr√©s[i], filtr√©s[j]] = [filtr√©s[j], filtr√©s[i]];
            }
        
            // 5. G√©n√©ration HTML
            filtr√©s.slice(0, 25).forEach(item => {
                const cell = document.createElement('div');
                cell.className = 'bingo-cell';
                cell.textContent = item.p;
                
                if (item.isGift) {
                    cell.classList.add('clicked');
                }
        
                cell.onclick = function() {
                    this.classList.toggle('clicked');
                    localStorage.setItem(STORAGE_KEY, card.innerHTML);
                    checkWin();
                };
                card.appendChild(cell);
            });
        
            localStorage.setItem(STORAGE_KEY, card.innerHTML);
            checkWin(); 
        }

        function checkWin() {
            const cells = Array.from(document.querySelectorAll('.bingo-cell'));
            const isClicked = i => cells[i].classList.contains('clicked');
            const wins = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
            
            // On cherche si une ligne gagnante existe
            const winningCombo = wins.find(c => c.every(isClicked));
        
            if (winningCombo) {
                const msg = document.getElementById('bingo-message');
                if (msg.classList.contains('show')) return;
                
                // --- DETECTION EASTER EGG ---
                // On v√©rifie si TOUTES les cases de la combinaison gagnante sont des bonus
                // Dans ton code, les bonus n'ont pas la cl√© .owner ou sont marqu√©s isGift
                const isFullLuck = winningCombo.every(index => {
                    const txt = cells[index].textContent;
                    return !banqueDeMots.some(m => m.p === txt); 
                });
        
                if (isFullLuck) {
                    msg.innerHTML = "üçÄ L'√âLU¬∑E üçÄ";
                    msg.style.background = "linear-gradient(45deg, #00FF87, #60EFFF)";
                } else {
                    msg.innerHTML = "BINGO !";
                    msg.style.background = "linear-gradient(45deg, #ff00cc, #3333ff)";
                }
                // ----------------------------
        
                msg.classList.add('show');
                triggerConfetti();
        
                setTimeout(() => {
                    let name = prompt(isFullLuck ? "Incroyable ! 5 cases bonus align√©es ! Quel est ton nom, √âlu¬∑e :" : "BINGO ! Ton nom :");
                    if (name) {
                        const cleanName = formatName(name.trim());
                        const now = Date.now();
                        const sessionID = "S_" + Math.random().toString(36).substr(2, 9);
                        
                        // Si c'est un coup de chance, on ajoute un suffixe au nom pour le podium
                        const displayName = isFullLuck ? `${cleanName} üçÄ` : cleanName;
        
                        database.ref('winners').push({ 
                            name: displayName, 
                            timestamp: now,
                            lucky: isFullLuck // On garde l'info en base au cas o√π
                        });
        
                        database.ref('bingo_signal').set({
                            winner: displayName,
                            timestamp: now,
                            sessionID: sessionID,
                            isLucky: isFullLuck
                        });
                    }
                    msg.classList.remove('show');
                }, 2600);
            }
        }

        function triggerConfetti() {
            for (let i = 0; i < 100; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                
                // --- POSITION ET COULEUR ---
                const startX = Math.random() * 100; // Position horizontale (0 √† 100vw)
                const startY = Math.random() * -20; // Commence un peu au-dessus de l'√©cran
                c.style.left = startX + 'vw';
                c.style.top = startY + 'vh';
                c.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                
                document.body.appendChild(c);
        
                // --- ANIMATION √âPARPILL√âE ---
                const duration = 2000 + Math.random() * 3000;
                const drift = (Math.random() - 0.5) * 20; // D√©rive lat√©rale (gauche/droite)
        
                c.animate([
                    { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(${drift}vw, 105vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).onfinish = () => c.remove();
            }
        }

        function resetHof() { 
            if(confirm("Effacer toute la saison (Podium ET Stats des cases) ?")) {
                database.ref('winners').remove(); 
                database.ref('session_votes').remove();
            }
        }
        
        function showWinnerAlert(winnerName, isLucky) {
            const alertBox = document.createElement('div');
            const color = isLucky ? "#00FF87" : "#FFD700";
            const text = isLucky ? `üçÄ INCROYABLE : ${winnerName} a gagn√© sans rien faire !` : `üèÜ ${winnerName} a eu un BINGO !`;
            
            alertBox.style = `position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#000; color:#fff; padding:15px 25px; border-radius:50px; z-index:9999; border:3px solid ${color}; font-weight:bold; box-shadow:0 10px 30px rgba(0,0,0,0.5); white-space:nowrap;`;
            alertBox.innerHTML = text;
            
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.style.transition = "all 0.5s";
                alertBox.style.opacity = "0";
                alertBox.style.top = "0px";
                setTimeout(() => alertBox.remove(), 500);
            }, 6000);
        }
        
        // 4. INIT
        document.addEventListener('DOMContentLoaded', () => {
            renderPresenceList();
            
            // Hall of Fame Listener
        database.ref('winners').on('value', (snap) => {
            const data = snap.val();
            const content = document.getElementById('hof-content');
            if (!data) { content.innerHTML = "Aucun gagnant pour le moment"; return; }
        
            const scores = {};
            Object.values(data).forEach(w => scores[w.name] = (scores[w.name] || 0) + 1);
            const ranking = Object.keys(scores).map(n => ({name: n, count: scores[n]})).sort((a,b) => b.count - a.count);
        
            content.innerHTML = ranking.map((w, i) => {
                const medal = i == 0 ? 'ü•á' : i == 1 ? 'ü•à' : i == 2 ? 'ü•â' : 'üë§';
                return `
                    <div class="hof-item">
                        <div class="hof-name">
                            <span>${medal}</span>
                            <span>${w.name}</span>
                        </div>
                        <div class="hof-score">
                            ${w.count} victoire${w.count > 1 ? 's' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        });

        const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                document.getElementById('bingo-card').innerHTML = saved;
                document.querySelectorAll('.bingo-cell').forEach(c => {
                    c.onclick = function() {
                        this.classList.toggle('clicked');
                        localStorage.setItem(STORAGE_KEY, document.getElementById('bingo-card').innerHTML);
                        checkWin();
                    };
                });
            } else {
                createBingoCard();
                togglePresencePanel(); // Ouvre par d√©faut si pas de sauvegarde
            }

        // A. √âcouter le signal de Bingo pour synchroniser les stats et l'alerte
        database.ref('bingo_signal').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
        
            const lastID = localStorage.getItem('processed_bingo');
            if (data.sessionID === lastID) return;
            localStorage.setItem('processed_bingo', data.sessionID);
        
        // 1. Alerte visuelle
        showWinnerAlert(data.winner); // Ta fonction d'alerte
        
        // 2. RECENSEMENT : Chaque joueur envoie ses cases coch√©es pour CETTE session
        document.querySelectorAll('.bingo-cell.clicked').forEach(cell => {
            const phrase = cell.textContent;
            
            // VERIFICATION : On ne compte la case que si elle fait partie de la banque officielle
            const existeDansBanque = banqueDeMots.some(m => m.p === phrase);
            
            if (existeDansBanque) {
                const safeKey = safeEncode(phrase);
                database.ref(`session_votes/${data.sessionID}/${safeKey}`).set(true);
            }
        });
        });
        
        // B. Afficher l'int√©gralit√© des Statistiques bas√©es sur les sessions uniques
        database.ref('session_votes').on('value', (snap) => {
            const allSessions = snap.val() || {};
            const container = document.getElementById('stats-content');
            if (!container) return;
        
            // 1. On calcule les totaux en comptant la pr√©sence de la cl√© dans chaque session
            const globalCounts = {};
            Object.values(allSessions).forEach(sessionCases => {
                // sessionCases contient toutes les safeKeys coch√©es lors d'une partie
                Object.keys(sessionCases).forEach(safeKey => {
                    globalCounts[safeKey] = (globalCounts[safeKey] || 0) + 1;
                });
            });
        
            // 2. On croise la banque de mots avec nos calculs de sessions
            const allStats = banqueDeMots.map(item => {
                const phrase = item.p;
                const safeKey = safeEncode(phrase); // Utilise ta fonction de formatage d'accent
                return {
                    txt: phrase,
                    val: globalCounts[safeKey] || 0
                };
            });
        
            // 3. Tri : d'abord le score (d√©croissant), puis alphab√©tique
            allStats.sort((a, b) => {
                if (b.val !== a.val) return b.val - a.val;
                return a.txt.localeCompare(b.txt);
            });
        
            // 4. G√©n√©ration du HTML
            container.innerHTML = allStats.map((s, index) => {
                const isTop = index === 0 && s.val > 0;
                return `
                    <div class="hof-item" style="
                        font-size:0.85rem; 
                        width: 90%; 
                        align-self: center; 
                        opacity: ${s.val === 0 ? '0.5' : '1'};
                        border-left: 4px solid ${isTop ? '#FFD700' : 'transparent'};
                        background: ${s.val > 0 ? '#fff' : 'rgba(255,255,255,0.4)'};
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px;
                        margin-bottom: 5px;
                        border-radius: 8px;
                        box-sizing: border-box;
                    ">
                        <span style="flex:1; text-align:left; padding-right:10px;">
                            ${isTop ? 'üî• ' : ''}${s.txt}
                        </span>
                        <span style="
                            background: ${s.val > 0 ? '#4CAF50' : '#ccc'}; 
                            color:white; 
                            padding:2px 10px; 
                            border-radius:15px; 
                            font-weight:bold; 
                            min-width:20px; 
                            text-align:center;
                        ">
                            ${s.val}
                        </span>
                    </div>
                `;
            }).join('');
        });

            document.getElementById('reset-btn').onclick = () => {
                togglePresencePanel(); // On ouvre juste le panneau
            };
        });
    </script>
</body>
</html>
